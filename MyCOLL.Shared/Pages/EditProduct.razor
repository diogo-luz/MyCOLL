@page "/produtos/novo"
@page "/produtos/editar/{Id:int}"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using MyCOLL.Shared.DTOs
@using MyCOLL.Shared.Services
@inject IProdutoService ProdutoService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>@Title - MyCOLL</PageTitle>

<AuthorizeView Roles="Fornecedor">
    <Authorized Context="authContext">
        <div class="edit-product-container">
            <h1 class="page-title">@Title</h1>

            @if (_loading) {
                <div class="loading">A carregar dados...</div>
            } else {
                <EditForm Model="@_produto" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator/>
                    <ValidationSummary/>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome</label>
                            <InputText @bind-Value="_produto.Nome" class="form-control"/>
                        </div>

                        <div class="form-group full-width">
                            <label>Descrição</label>
                            <InputTextArea @bind-Value="_produto.Descricao" class="form-control" rows="3"/>
                        </div>

                        <div class="form-group">
                            <label>Preço Base (€)</label>
                            <InputNumber @bind-Value="_produto.PrecoBase" class="form-control"/>
                        </div>

                        <div class="form-group">
                            <label>Stock</label>
                            <InputNumber @bind-Value="_produto.Stock" class="form-control"/>
                        </div>

                        <div class="form-group">
                            <label>Categoria</label>
                            <InputSelect @bind-Value="_produto.CategoriaId" class="form-control">
                                <option value="">-- Selecione --</option>
                                @foreach (var c in _categorias) {
                                    <option value="@c.Id">@c.Nome</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="form-group">
                            <label>Tipo Colecionável</label>
                            <InputSelect @bind-Value="_produto.TipoColecionavelId" class="form-control">
                                <option value="">-- Selecione --</option>
                                @foreach (var t in _tipos) {
                                    <option value="@t.Id">@t.Nome</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="form-group">
                            <label>País</label>
                            <InputSelect @bind-Value="_produto.PaisId" class="form-control">
                                <option value="">-- Selecione --</option>
                                @foreach (var p in _paises) {
                                    <option value="@p.Id">@p.Nome</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="form-group">
                            <label>Ano</label>
                            <InputNumber @bind-Value="_produto.Ano" class="form-control"/>
                        </div>

                        <div class="form-group">
                            <label>Estado de Conservação</label>
                            <InputText @bind-Value="_produto.Estado" class="form-control"/>
                        </div>

                        <div class="form-group">
                            <label>Modo de Disponibilização</label>
                            <InputSelect @bind-Value="_produto.ModoDisponibilizacaoId" class="form-control">
                                <option value="">-- Selecione --</option>
                                @foreach (var m in _modos) {
                                    <option value="@m.Id">@m.Nome</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="form-group checkbox-group">
                            <InputCheckbox @bind-Value="_produto.ParaVenda" id="paravenda"/>
                            <label for="paravenda">Disponível para Venda</label>
                        </div>

                        <div class="form-group full-width">
                            <label>Imagem</label>
                            <InputFile OnChange="HandleFileSelected" accept="image/*" class="form-control"/>
                            @if (_produto.Imagem != null) {
                                <div class="image-preview mt-2">
                                    <img src="data:image/png;base64,@Convert.ToBase64String(_produto.Imagem)" style="max-height: 150px;"/>
                                </div>
                            } else if (!string.IsNullOrEmpty(_produto.UrlImagem)) {
                                <div class="image-preview mt-2">
                                    <img src="@_produto.UrlImagem" style="max-height: 150px;"/>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" disabled="@_submitting">
                            @if (_submitting) {
                                <span>A guardar...</span>
                            } else {
                                <span>Guardar</span>
                            }
                        </button>
                        <a href="/fornecedor/produtos" class="btn btn-secondary">Cancelar</a>

                        @if (Id > 0) {
                            <button type="button" class="btn btn-danger" @onclick="DeleteProduct">Apagar</button>
                        }
                    </div>
                </EditForm>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h2>Acesso Restrito</h2>
            <a href="/login" class="btn btn-primary">Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int Id { get; set; }

    private ProdutoDTO _produto = new() { ParaVenda = true };
    private List<CategoriaDTO> _categorias = new();
    private List<TipoColecionavelDTO> _tipos = new();
    private List<PaisDTO> _paises = new();
    private List<ModoDisponibilizacaoDTO> _modos = new();

    private bool _loading = true;
    private bool _submitting = false;

    private string Title => Id > 0 ? "Editar Produto" : "Novo Produto";

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            await LoadDataAsync();
            StateHasChanged();
        }
    }

    private async Task LoadDataAsync() {
        _loading = true;
        // Carregar listas auxiliares
        var t1 = ProdutoService.GetCategoriasAsync();
        var t2 = ProdutoService.GetTiposAsync();
        var t3 = ProdutoService.GetPaisesAsync();
        var t4 = ProdutoService.GetModosAsync();

        await Task.WhenAll(t1, t2, t3, t4);
        _categorias = await t1;
        _tipos = await t2;
        _paises = await t3;
        _modos = await t4;

        if (Id > 0) {
            var prod = await ProdutoService.GetByIdAsync(Id);
            if (prod != null) {
                _produto = prod;
            } else {
                Navigation.NavigateTo("/fornecedor/produtos");
            }
        }

        _loading = false;
    }

    private async Task HandleSubmit() {
        _submitting = true;
        ProdutoDTO? result;

        if (Id > 0) {
            result = await ProdutoService.UpdateProductAsync(_produto);
        } else {
            result = await ProdutoService.CreateProductAsync(_produto);
        }

        _submitting = false;

        if (result != null) {
            Navigation.NavigateTo("/fornecedor/produtos");
        } else {
            Console.WriteLine("Erro ao guardar");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e) {
        var file = e.File;
        if (file != null) {
            // Limitar tamanho a 5MB
            var resizedFile = await file.RequestImageFileAsync("image/png", 800, 600);
            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).ReadAsync(buffer);
            _produto.Imagem = buffer;
            _produto.UrlImagem = null;
        }
    }

    private async Task DeleteProduct() {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Tem a certeza que deseja apagar este produto?");
        if (confirmed) {
            var success = await ProdutoService.DeleteProductAsync(Id);
            if (success) Navigation.NavigateTo("/fornecedor/produtos");
        }
    }

}
