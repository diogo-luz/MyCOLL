@page "/fornecedor/produtos"
@using Microsoft.AspNetCore.Components.Authorization
@using MyCOLL.Shared.DTOs
@using MyCOLL.Shared.Services
@inject IProdutoService ProdutoService

<PageTitle>Meus Produtos - MyCOLL</PageTitle>

<AuthorizeView Roles="Fornecedor">
    <Authorized>
        <div class="my-products-container">
            <div class="header-actions">
                <h1 class="page-title">üè∑Ô∏è Meus Produtos</h1>
                <a href="/produtos/novo" class="btn btn-primary">+ Novo Produto</a>
            </div>

            @if (_loading) {
                <div class="loading">A carregar produtos...</div>
            } else if (!_produtos.Any()) {
                <div class="empty-state">
                    <div class="empty-icon">üè∑Ô∏è</div>
                    <h2>Sem produtos</h2>
                    <p>Ainda n√£o colocou nenhum produto √† venda.</p>
                </div>
            } else {
                <div class="products-grid">
                    @foreach (var produto in _produtos) {
                        <div class="product-card @(produto.Activo ? "" : "inactive")">
                            <div class="product-image">
                                @if (!string.IsNullOrEmpty(produto.UrlImagem)) {
                                    <img src="@produto.UrlImagem" alt="@produto.Nome"/>
                                } else if (produto.Imagem != null) {
                                    <img src="data:image/png;base64,@Convert.ToBase64String(produto.Imagem)" alt="@produto.Nome"/>
                                } else {
                                    <div class="no-image">Sem Imagem</div>
                                }

                                <div class="status-overlay">
                                    @if (produto.Activo) {
                                        <span class="badge badge-success">Ativo</span>
                                    } else {
                                        <span class="badge badge-warning">Pendente/Inativo</span>
                                    }
                                </div>
                            </div>

                            <div class="product-details">
                                <h3>@produto.Nome</h3>
                                <div class="price-stock">
                                    <span class="price">@produto.PrecoFinal.ToString("C")</span>
                                    <span class="stock">Stock: @produto.Stock</span>
                                </div>
                                <div class="product-info">
                                    <span>@produto.CategoriaNome</span>
                                    <span>@produto.Estado</span>
                                </div>
                            </div>

                            <div class="product-actions">
                                <a href="/produtos/editar/@produto.Id" class="btn btn-sm btn-outline">Editar</a>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container text-center mt-5">
            <h2>üîí Acesso Restrito</h2>
            <p>Apenas fornecedores podem aceder a esta p√°gina.</p>
            <a href="/login" class="btn btn-primary">Entrar</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<ProdutoDTO> _produtos = new();
    private bool _loading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _produtos = await ProdutoService.GetMyProductsAsync();
            _loading = false;
            StateHasChanged();
        }
    }

}
