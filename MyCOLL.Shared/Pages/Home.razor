@page "/"
@inject IProdutoService ProdutoService
@inject ICarrinhoService CarrinhoService
@inject NavigationManager Nav

<PageTitle>MyCOLL - Colecion√°veis</PageTitle>

<div class="container py-4">
    @* Category Slider *@
    <section class="mb-5">
        <h2 class="h4 fw-bold mb-4 border-start border-4 border-primary ps-3">Explorar por Categoria</h2>
        <CategorySlider Categorias="_categorias"
                        SelectedId="_selectedCategoriaId"
                        OnCategorySelected="OnCategorySelected"/>
    </section>

    @* Products Grid *@
    <section class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 fw-bold mb-0 border-start border-4 border-primary ps-3">
                @if (_selectedCategoriaId.HasValue) {
                    <span>@(_categorias.FirstOrDefault(c => c.Id == _selectedCategoriaId)?.Nome ?? "Produtos")</span>
                } else {
                    <span>Todos os Produtos</span>
                }
            </h2>

            @if (_selectedCategoriaId.HasValue) {
                <button class="btn btn-outline-secondary btn-sm" @onclick="ClearFilter">
                    <i class="bi bi-x-lg me-1"></i>Limpar filtro
                </button>
            }
        </div>

        @if (_loading) {
            <div class="d-flex justify-content-center align-items-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">A carregar...</span>
                </div>
            </div>
        } else if (!_produtos.Any()) {
            <div class="text-center py-5 text-muted">
                <i class="bi bi-search display-1 mb-3"></i>
                <p>Nenhum produto encontrado.</p>
            </div>
        } else {
            <div class="row">
                @foreach (var produto in _filteredProdutos) {
                    <ProductCard Produto="produto"
                                 OnViewDetails="ViewDetails"
                                 OnAddToCart="AddToCart"/>
                }
            </div>
        }
    </section>

    @* Suggestion Banner *@
    @if (_suggestion != null) {
        <section class="mb-5">
            <h2 class="h4 fw-bold mb-4 border-start border-4 border-warning ps-3">Destaque do Dia</h2>
            <ProductSuggestion Produto="_suggestion" OnClick="ViewDetails"/>
        </section>
    }
</div>

@code {
    private List<CategoriaDTO> _categorias = new();
    private List<ProdutoDTO> _produtos = new();
    private ProdutoDTO? _suggestion;
    private int? _selectedCategoriaId;
    private bool _loading = true;

    private IEnumerable<ProdutoDTO> _filteredProdutos {
        get {
            Console.WriteLine($"[Home] Total: {_produtos.Count}, SelectedCat: {_selectedCategoriaId}");
            var filtered = _selectedCategoriaId.HasValue
                ? _produtos.Where(p => p.CategoriaId == _selectedCategoriaId.Value)
                : _produtos;
            Console.WriteLine($"[Home] Filtered: {filtered.Count()}");
            return filtered;
        }
    }

    protected override async Task OnInitializedAsync() {
        try {
            _categorias = await ProdutoService.GetCategoriasAsync();
            _produtos = await ProdutoService.GetAllAsync();

            // Pick random suggestion
            if (_produtos.Any()) {
                var random = new Random();
                _suggestion = _produtos[random.Next(_produtos.Count)];
            }
        } catch (Exception) {
            // Handle error
        } finally {
            _loading = false;
        }
    }

    private Task OnCategorySelected(int? categoriaId) {
        _selectedCategoriaId = categoriaId;
        return Task.CompletedTask;
    }

    private void ClearFilter() {
        _selectedCategoriaId = null;
    }

    private void ViewDetails(int produtoId) {
        Nav.NavigateTo($"/produto/{produtoId}");
    }

    private async Task AddToCart(ProdutoDTO produto) {
        await CarrinhoService.AddItemAsync(produto);
        // Could add toast notification here
    }

}
