@page "/perfil"
@using MyCOLL.Shared.DTOs
@using MyCOLL.Shared.Services
@inject IAuthService AuthService
@inject NavigationManager Nav

<PageTitle>O Meu Perfil - MyCOLL</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container py-5">
            <h1 class="mb-4 fw-bold"><i class="bi bi-person-circle me-2"></i>O Meu Perfil</h1>

            <div class="row">
                <div class="col-md-3 mb-4">
                    <div class="card border-0 shadow-sm text-center py-4">
                        <div class="mb-3 position-relative d-inline-block">
                            @if (_profile?.Fotografia != null) {
                                <img src="data:image/png;base64,@Convert.ToBase64String(_profile.Fotografia)"
                                     class="rounded-circle object-fit-cover border border-3 border-white shadow-sm"
                                     style="width: 120px; height: 120px;" alt="Profile"/>
                            } else {
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto text-secondary border border-3 border-white shadow-sm"
                                     style="width: 120px; height: 120px;">
                                    <i class="bi bi-person-fill display-4"></i>
                                </div>
                            }
                        </div>
                        <h4 class="fw-bold mb-1">@(_profile?.Nome) @(_profile?.Apelido)</h4>
                        <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">
                            @(_profile?.TipoUtilizador ?? "Utilizador")
                        </span>
                    </div>

                    <div class="list-group mt-4 shadow-sm rounded-3 overflow-hidden border-0">
                        <button class="list-group-item list-group-item-action py-3 @(_activeTab == "dados" ? "active fw-bold" : "")"
                                @onclick='() => _activeTab = "dados"'>
                            <i class="bi bi-person-vcard me-2"></i>Dados Pessoais
                        </button>
                        <button class="list-group-item list-group-item-action py-3 @(_activeTab == "seguranca" ? "active fw-bold" : "")"
                                @onclick='() => _activeTab = "seguranca"'>
                            <i class="bi bi-shield-lock me-2"></i>Segurança
                        </button>
                    </div>
                </div>

                <div class="col-md-9">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            @if (_message != null) {
                                <div class="alert @(_isSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
                                    @if (_isSuccess) {
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                    } else {
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    }
                                    @_message
                                    <button type="button" class="btn-close" @onclick="() => _message = null"></button>
                                </div>
                            }

                            @if (_loading) {
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">A carregar...</span>
                                    </div>
                                </div>
                            } else if (_activeTab == "dados" && _profile != null) {
                                <h3 class="fw-bold mb-4">Editar Dados Pessoais</h3>
                                <EditForm Model="_profile" OnValidSubmit="HandleUpdateProfile" Context="editContext">
                                    <DataAnnotationsValidator/>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">Nome</label>
                                            <InputText @bind-Value="_profile.Nome" class="form-control"/>
                                            <ValidationMessage For="() => _profile.Nome"/>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">Apelido</label>
                                            <InputText @bind-Value="_profile.Apelido" class="form-control"/>
                                            <ValidationMessage For="() => _profile.Apelido"/>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">Email (Não editável)</label>
                                            <input type="text" class="form-control bg-light" value="@_profile.Email" readonly disabled/>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">NIF</label>
                                            <InputNumber @bind-Value="_profile.NIF" class="form-control"/>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label small fw-bold text-muted">Rua</label>
                                            <InputText @bind-Value="_profile.Rua" class="form-control"/>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">Código Postal</label>
                                            <InputText @bind-Value="_profile.CodigoPostal" class="form-control"/>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">Localidade</label>
                                            <InputText @bind-Value="_profile.Localidade" class="form-control"/>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">País</label>
                                            <InputText @bind-Value="_profile.Pais" class="form-control"/>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">Telefone</label>
                                            <InputText @bind-Value="_profile.Telefone" class="form-control"/>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label small fw-bold text-muted">Fotografia</label>
                                            <InputFile OnChange="HandleFileSelected" class="form-control" accept=".jpg,.jpeg,.png"/>
                                            <div class="form-text">Formatos aceites: JPG, PNG. Máx 5MB.</div>
                                        </div>
                                    </div>

                                    <div class="mt-4 pt-3 border-top text-end">
                                        <button type="submit" class="btn btn-primary px-4" disabled="@_submitting">
                                            @if (_submitting) {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                            }
                                            Guardar Alterações
                                        </button>
                                    </div>
                                </EditForm>
                            } else if (_activeTab == "seguranca") {
                                <h3 class="fw-bold mb-4">Alterar Password</h3>
                                <EditForm Model="_passwordModel" OnValidSubmit="HandleChangePassword" Context="passwordContext">
                                    <DataAnnotationsValidator/>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">Password Atual</label>
                                        <InputText @bind-Value="_passwordModel.CurrentPassword" type="password" class="form-control"/>
                                        <ValidationMessage For="() => _passwordModel.CurrentPassword"/>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">Nova Password</label>
                                        <InputText @bind-Value="_passwordModel.NewPassword" type="password" class="form-control"/>
                                        <ValidationMessage For="() => _passwordModel.NewPassword"/>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">Confirmar Nova Password</label>
                                        <InputText @bind-Value="_passwordModel.ConfirmNewPassword" type="password" class="form-control"/>
                                        <ValidationMessage For="() => _passwordModel.ConfirmNewPassword"/>
                                    </div>

                                    <div class="mt-4 pt-3 border-top text-end">
                                        <button type="submit" class="btn btn-warning px-4 text-dark fw-medium" disabled="@_submitting">
                                            @if (_submitting) {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                            }
                                            Atualizar Password
                                        </button>
                                    </div>
                                </EditForm>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container py-5 text-center">
            <h2>Acesso Negado</h2>
            <p>Por favor faça login para ver o seu perfil.</p>
            <a href="/login" class="btn btn-primary">Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private UserProfileDTO? _profile;
    private ChangePasswordDTO _passwordModel = new();
    private string _activeTab = "dados";
    private bool _loading = true;
    private bool _submitting = false;
    private string? _message;
    private bool _isSuccess;

    protected override async Task OnInitializedAsync() {
        await LoadProfile();
    }

    private async Task LoadProfile() {
        _loading = true;
        _profile = await AuthService.GetProfileAsync();
        _loading = false;
    }

    private async Task HandleUpdateProfile() {
        if (_profile == null) return;
        _submitting = true;
        _message = null;

        var result = await AuthService.UpdateProfileAsync(_profile);
        _isSuccess = result.Success;
        _message = result.Success ? "Dados atualizados com sucesso." : (result.Error ?? "Erro ao atualizar dados.");

        _submitting = false;
    }

    private async Task HandleChangePassword() {
        _submitting = true;
        _message = null;

        var result = await AuthService.ChangePasswordAsync(_passwordModel);
        _isSuccess = result.Success;
        _message = result.Success ? "Password alterada com sucesso." : (result.Error ?? "Erro ao alterar password.");

        if (result.Success) {
            _passwordModel = new ChangePasswordDTO(); // Limpar form
        }

        _submitting = false;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e) {
        if (_profile == null) return;

        var file = e.File;
        // Limit to 5MB
        if (file.Size > 5120000) {
            _message = "A imagem é demasiado grande (Máx 5MB).";
            _isSuccess = false;
            return;
        }

        try {
            using var stream = file.OpenReadStream(5120000);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            _profile.Fotografia = ms.ToArray();
        } catch (Exception) {
            _message = "Erro ao carregar imagem.";
            _isSuccess = false;
        }
    }

}
