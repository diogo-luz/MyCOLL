@page "/roles/delete"
@using Microsoft.EntityFrameworkCore
@inject RoleManager<IdentityRole> RoleManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Eliminar Role</PageTitle>

<h1>Eliminar Role</h1>

<p class="text-danger"><strong>Tem a certeza que pretende eliminar esta role?</strong></p>
<div>
    <hr/>
    @if (role is null) {
        <p><em>A carregar...</em></p>
    } else {
        <dl class="row">
            <dt class="col-sm-2">Nome</dt>
            <dd class="col-sm-10">@role.Name</dd>
            <dt class="col-sm-2">Utilizadores</dt>
            <dd class="col-sm-10">@userCount utilizador(es) com esta role</dd>
        </dl>
        
        @if (userCount > 0) {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Atenção:</strong> Existem @userCount utilizador(es) com esta role. 
                Ao eliminar, estes utilizadores perderão esta role.
            </div>
        }
        
        @if (!string.IsNullOrEmpty(errorMessage)) {
            <div class="alert alert-danger">@errorMessage</div>
        }
        
        <EditForm method="post" Model="role" OnValidSubmit="DeleteRole" FormName="delete">
            <button type="submit" class="btn btn-danger" disabled="@(role is null)">Eliminar</button> |
            <a href="/roles">Cancelar</a>
        </EditForm>
    }
</div>

@code {
    private IdentityRole? role;
    private int userCount;
    private string? errorMessage;

    [SupplyParameterFromQuery] private string? Id { get; set; }

    protected override async Task OnInitializedAsync() {
        if (string.IsNullOrEmpty(Id)) {
            NavigationManager.NavigateTo("notfound");
            return;
        }
        
        role = await RoleManager.FindByIdAsync(Id);

        if (role is null) {
            NavigationManager.NavigateTo("notfound");
            return;
        }
        
        var usersInRole = await UserManager.GetUsersInRoleAsync(role.Name!);
        userCount = usersInRole.Count;
    }

    private async Task DeleteRole() {
        if (role is null) return;
        
        // Prevent deleting Admin role
        if (role.Name == "Admin") {
            errorMessage = "A role 'Admin' não pode ser eliminada.";
            return;
        }
        
        var result = await RoleManager.DeleteAsync(role);
        
        if (result.Succeeded) {
            NavigationManager.NavigateTo("/roles");
        } else {
            errorMessage = string.Join("; ", result.Errors.Select(e => e.Description));
        }
    }
}
