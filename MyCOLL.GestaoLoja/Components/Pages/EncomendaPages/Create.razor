@page "/encomendas/create"
@using Microsoft.EntityFrameworkCore
@using MyCOLL.Data.Entities
@using MyCOLL.Data.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Criar Encomenda</PageTitle>

<h1>Criar Encomenda</h1>

<hr/>
<div class="row">
    <div class="col-md-4">
        <EditForm method="post" Model="Encomenda" OnValidSubmit="AddEncomenda" FormName="create">
            <DataAnnotationsValidator/>
            <ValidationSummary class="text-danger" role="alert"/>
            <div class="mb-3">
                <label for="dataencomenda" class="form-label">Data Encomenda:</label>
                <InputDate id="dataencomenda" @bind-Value="Encomenda.DataEncomenda" class="form-control"/>
                <ValidationMessage For="() => Encomenda.DataEncomenda" class="text-danger"/>
            </div>
            <div class="mb-3">
                <span class="text-danger">*</span>
                <label for="estado" class="form-label">Estado:</label>
                <InputSelect id="estado" class="form-select" @bind-Value="Encomenda.Estado">
                    <option value="">Escolha um estado</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Confirmada">Confirmada</option>
                    <option value="Expedida">Expedida</option>
                    <option value="Entregue">Entregue</option>
                    <option value="Cancelada">Cancelada</option>
                </InputSelect>
                <ValidationMessage For="() => Encomenda.Estado" class="text-danger"/>
            </div>
            <div class="mb-3">
                <label for="total" class="form-label">Total (€):</label>
                <InputNumber id="total" @bind-Value="Encomenda.Total" class="form-control"/>
                <ValidationMessage For="() => Encomenda.Total" class="text-danger"/>
            </div>
            <div class="mb-3">
                <label for="observacoes" class="form-label">Observações:</label>
                <InputText id="observacoes" @bind-Value="Encomenda.Observacoes" class="form-control"/>
                <ValidationMessage For="() => Encomenda.Observacoes" class="text-danger"/>
            </div>
            <div class="mb-3">
                <span class="text-danger">*</span>
                <label for="clienteid" class="form-label">Cliente:</label>
                <InputSelect id="clienteid" class="form-select" @bind-Value="Encomenda.ClienteId">
                    <option value="">Escolha um cliente</option>
                    @foreach (var item in clientes) {
                        <option value="@item.Id">@item.Nome @item.Apelido (@item.Email)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Encomenda.ClienteId" class="text-danger"/>
            </div>
            <button type="submit" class="btn btn-primary">Criar</button>
        </EditForm>
    </div>
</div>

<div>
    <a href="/encomendas">Voltar à lista</a>
</div>

@code {
    [SupplyParameterFromForm] private Encomenda Encomenda { get; set; } = new();

    List<ApplicationUser> clientes = new();

    protected override async Task OnInitializedAsync() {
        await using var context = DbFactory.CreateDbContext();
        clientes = await context.Users.Where(u => u.TipoUtilizador == "Cliente").ToListAsync();
    }

    private async Task AddEncomenda() {
        using var context = DbFactory.CreateDbContext();
        context.Encomendas.Add(Encomenda);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/encomendas");
    }

}
