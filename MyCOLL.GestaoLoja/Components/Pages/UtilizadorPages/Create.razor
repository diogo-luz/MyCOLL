@page "/utilizadores/create"
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavigationManager

<PageTitle>Criar Utilizador</PageTitle>

<h1>Criar Utilizador</h1>
<hr/>

<div class="row">
    <div class="col-md-6">
        <EditForm Model="modelo" OnValidSubmit="CreateUtilizador" FormName="create">
            <DataAnnotationsValidator/>
            <ValidationSummary class="text-danger" role="alert"/>
            
            @if (!string.IsNullOrEmpty(errorMessage)) {
                <div class="alert alert-danger">@errorMessage</div>
            }
            
            <div class="mb-3">
                <span class="text-danger">*</span>
                <label for="nome" class="form-label">Nome:</label>
                <InputText id="nome" @bind-Value="modelo.Nome" class="form-control" aria-required="true"/>
            </div>
            <div class="mb-3">
                <label for="apelido" class="form-label">Apelido:</label>
                <InputText id="apelido" @bind-Value="modelo.Apelido" class="form-control"/>
            </div>
            <div class="mb-3">
                <span class="text-danger">*</span>
                <label for="email" class="form-label">Email:</label>
                <InputText id="email" @bind-Value="modelo.Email" class="form-control" aria-required="true"/>
            </div>
            <div class="mb-3">
                <span class="text-danger">*</span>
                <label for="password" class="form-label">Password:</label>
                <InputText id="password" @bind-Value="modelo.Password" class="form-control" type="password" aria-required="true"/>
                <small class="text-muted">Mínimo 6 caracteres, pelo menos uma maiúscula e um número.</small>
            </div>
            <div class="mb-3">
                <label for="nif" class="form-label">NIF:</label>
                <InputNumber id="nif" @bind-Value="modelo.NIF" class="form-control"/>
            </div>
            <div class="mb-3">
                <label for="rua" class="form-label">Rua:</label>
                <InputText id="rua" @bind-Value="modelo.Rua" class="form-control"/>
            </div>
            <div class="mb-3">
                <label for="codigopostal" class="form-label">Código Postal:</label>
                <InputText id="codigopostal" @bind-Value="modelo.CodigoPostal" class="form-control"/>
            </div>
            <div class="mb-3">
                <label for="localidade" class="form-label">Localidade:</label>
                <InputText id="localidade" @bind-Value="modelo.Localidade" class="form-control"/>
            </div>
            <div class="mb-3">
                <label for="pais" class="form-label">País:</label>
                <InputText id="pais" @bind-Value="modelo.Pais" class="form-control"/>
            </div>
            <div class="mb-3">
                <label for="tipo" class="form-label">Tipo de Utilizador:</label>
                <InputSelect id="tipo" class="form-select" @bind-Value="modelo.TipoUtilizador">
                    <option value="">Escolha um tipo</option>
                    <option value="Cliente">Cliente</option>
                    <option value="Fornecedor">Fornecedor</option>
                </InputSelect>
            </div>
            <div class="mb-3 form-check">
                <InputCheckbox id="activo" @bind-Value="modelo.Activo" class="form-check-input"/>
                <label for="activo" class="form-check-label">Conta Activa</label>
            </div>
            <div class="mb-3 form-check">
                <InputCheckbox id="emailConfirmed" @bind-Value="modelo.EmailConfirmed" class="form-check-input"/>
                <label for="emailConfirmed" class="form-check-label">Email Confirmado</label>
            </div>
            
            <h4 class="mt-4">Roles</h4>
            <div class="mb-3">
                @foreach (var role in todasRoles) {
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="role_@role" 
                               checked="@selectedRoles.Contains(role)"
                               @onchange="@(e => ToggleRole(role, (bool)e.Value!))"/>
                        <label class="form-check-label" for="role_@role">@role</label>
                    </div>
                }
            </div>
            
            <button type="submit" class="btn btn-primary">Criar</button>
        </EditForm>
    </div>
</div>

<div class="mt-3">
    <a href="/utilizadores">Voltar à lista</a>
</div>

@code {
    private CreateUserModel modelo = new();
    private List<string> todasRoles = new();
    private List<string> selectedRoles = new();
    private string? errorMessage;

    protected override async Task OnInitializedAsync() {
        todasRoles = await RoleManager.Roles.Select(r => r.Name!).ToListAsync();
    }

    private void ToggleRole(string role, bool isChecked) {
        if (isChecked && !selectedRoles.Contains(role)) {
            selectedRoles.Add(role);
        } else if (!isChecked && selectedRoles.Contains(role)) {
            selectedRoles.Remove(role);
        }
    }

    private async Task CreateUtilizador() {
        errorMessage = null;
        
        var user = new ApplicationUser {
            UserName = modelo.Email,
            Email = modelo.Email,
            Nome = modelo.Nome,
            Apelido = modelo.Apelido,
            NIF = modelo.NIF,
            Rua = modelo.Rua,
            CodigoPostal = modelo.CodigoPostal,
            Localidade = modelo.Localidade,
            Pais = modelo.Pais,
            TipoUtilizador = modelo.TipoUtilizador,
            Activo = modelo.Activo,
            EmailConfirmed = modelo.EmailConfirmed
        };
        
        var result = await UserManager.CreateAsync(user, modelo.Password ?? "");
        
        if (result.Succeeded) {
            if (selectedRoles.Count > 0) {
                await UserManager.AddToRolesAsync(user, selectedRoles);
            }
            NavigationManager.NavigateTo("/utilizadores");
        } else {
            errorMessage = string.Join("; ", result.Errors.Select(e => e.Description));
        }
    }

    private class CreateUserModel {
        public string? Nome { get; set; }
        public string? Apelido { get; set; }
        public string? Email { get; set; }
        public string? Password { get; set; }
        public long? NIF { get; set; }
        public string? Rua { get; set; }
        public string? CodigoPostal { get; set; }
        public string? Localidade { get; set; }
        public string? Pais { get; set; }
        public string? TipoUtilizador { get; set; }
        public bool Activo { get; set; } = true;
        public bool EmailConfirmed { get; set; } = true;
    }
}
