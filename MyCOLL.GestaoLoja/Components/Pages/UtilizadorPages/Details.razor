@page "/utilizadores/details"
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Detalhes Utilizador</PageTitle>

<h1>Detalhes do Utilizador</h1>

<div>
    <hr/>
    @if (utilizador is null) {
        <p>
            <em>A carregar...</em>
        </p>
    } else {
        <div class="row">
            <div class="col-md-3 text-center">
                @if (utilizador.Fotografia is not null && utilizador.Fotografia.Length > 0) {
                    <img src="@($"data:image/png;base64, {Convert.ToBase64String(utilizador.Fotografia)}")" alt="@utilizador.Nome" class="img-fluid rounded-circle" style="max-width: 150px;"/>
                } else {
                    <i class="bi bi-person-circle" style="font-size: 8rem;"></i>
                }
            </div>
            <div class="col-md-9">
                <dl class="row">
                    <dt class="col-sm-3">Nome</dt>
                    <dd class="col-sm-9">@utilizador.Nome @utilizador.Apelido</dd>
                    <dt class="col-sm-3">Email</dt>
                    <dd class="col-sm-9">@utilizador.Email</dd>
                    <dt class="col-sm-3">NIF</dt>
                    <dd class="col-sm-9">@utilizador.NIF</dd>
                    <dt class="col-sm-3">Morada</dt>
                    <dd class="col-sm-9">@utilizador.Rua, @utilizador.CodigoPostal @utilizador.Localidade, @utilizador.Pais</dd>
                    <dt class="col-sm-3">Tipo</dt>
                    <dd class="col-sm-9">@utilizador.TipoUtilizador</dd>
                    <dt class="col-sm-3">Estado</dt>
                    <dd class="col-sm-9">
                        @if (utilizador.Activo) {
                            <span class="badge bg-success">Activo</span>
                        } else {
                            <span class="badge bg-warning">Inactivo</span>
                        }
                    </dd>
                    <dt class="col-sm-3">Roles</dt>
                    <dd class="col-sm-9">
                        @foreach (var role in userRoles) {
                            <span class="badge bg-primary me-1">@role</span>
                        }
                    </dd>
                    <dt class="col-sm-3">Email Confirmado</dt>
                    <dd class="col-sm-9">@(utilizador.EmailConfirmed ? "Sim" : "Não")</dd>
                </dl>
            </div>
        </div>
        <div class="mt-3">
            <a href="@($"/utilizadores/edit?id={utilizador.Id}")">Editar</a> |
            <a href="/utilizadores">Voltar à lista</a>
        </div>
    }
</div>

@code {
    private ApplicationUser? utilizador;
    private IList<string> userRoles = new List<string>();

    [SupplyParameterFromQuery] private string? Id { get; set; }

    protected override async Task OnInitializedAsync() {
        if (string.IsNullOrEmpty(Id)) {
            NavigationManager.NavigateTo("notfound");
            return;
        }
        
        using var context = DbFactory.CreateDbContext();
        utilizador = await context.Users.FirstOrDefaultAsync(u => u.Id == Id);

        if (utilizador is null) {
            NavigationManager.NavigateTo("notfound");
            return;
        }
        
        userRoles = await UserManager.GetRolesAsync(utilizador);
    }
}
